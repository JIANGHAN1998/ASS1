<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swimmate - Port Phillip Bay Water Quality Analysis</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Source Sans Pro', -apple-system, system-ui, sans-serif; 
      background: #f7fafc;
      color: #2d3748;
      line-height: 1.6;
    }
    
    .header {
      background: linear-gradient(135deg, #2b6cb0 0%, #1a365d 100%);
      color: white;
      padding: 24px 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      font-size: 28px;
      font-weight: 700;
      color: #63b3ed;
    }
    
    .tagline {
      font-size: 16px;
      opacity: 0.9;
      font-weight: 300;
    }
    
    .data-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 24px;
    }
    
    .analysis-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .card-nav {
      background: #edf2f7;
      padding: 0;
      display: flex;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .nav-button {
      flex: 1;
      padding: 16px 24px;
      border: none;
      background: transparent;
      font-size: 16px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
    }
    
    .nav-button.active {
      background: white;
      color: #2b6cb0;
      border-bottom-color: #2b6cb0;
    }
    
    .nav-button:hover:not(.active) {
      background: rgba(255,255,255,0.7);
      color: #2d3748;
    }
    
    .controls-panel {
      padding: 24px;
      background: #f7fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .control-row {
      display: flex;
      align-items: end;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
    }
    
    .field-label {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }
    
    .field-input {
      padding: 12px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 15px;
      background: white;
      transition: border-color 0.2s ease;
    }
    
    .field-input:focus {
      outline: none;
      border-color: #2b6cb0;
      box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.1);
    }
    
    .analyze-btn {
      padding: 12px 24px;
      background: #2b6cb0;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      height: fit-content;
    }
    
    .analyze-btn:hover {
      background: #2c5282;
    }
    
    .analyze-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }
    
    .content-area {
      display: grid;
      grid-template-columns: 1fr 450px;
      gap: 32px;
      padding: 32px 24px;
      min-height: 500px;
    }
    
    /* Full width layout for comparison mode */
    .comparison-mode .content-area {
      grid-template-columns: 1fr;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .comparison-mode .insights-sidebar {
      display: none;
    }
    
    .chart-section {
      position: relative;
    }
    
    .chart-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .chart-container {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      min-height: 450px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: visible;
    }
    
    .chart-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6);
      border-radius: 14px;
      z-index: -1;
      opacity: 0.1;
    }
    
    .empty-state {
      text-align: center;
      color: #718096;
      font-size: 16px;
    }
    
    .insights-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 450px;
      padding-bottom: 24px;
    }
    
    .insight-box {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 24px;
      overflow: visible;
      word-wrap: break-word;
      width: 100%;
      box-sizing: border-box;
    }
    
    .insight-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 12px;
    }
    
    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .metric-item {
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #2b6cb0;
      display: block;
    }
    
    .metric-label {
      font-size: 12px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    
    .quality-breakdown {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .quality-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
      min-height: 44px;
      width: 100%;
    }
    
    .quality-item:last-child {
      border-bottom: none;
    }
    
    .quality-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .quality-indicator {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    
    .safe { background: #48bb78; }
    .relatively-safe { background: #ed8936; }
    .caution { background: #f97316; }
    .unsafe { background: #ef4444; }
    
    .quality-count {
      font-weight: 700;
      color: #2d3748 !important;
      font-size: 18px !important;
      min-width: 40px;
      text-align: right;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      background: #f7fafc;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    
    .recommendation-box {
      background: linear-gradient(135deg, #ebf8ff, #bee3f8);
      border-left: 4px solid #2b6cb0;
      padding: 16px;
      border-radius: 6px;
    }
    
    .recommendation-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a365d;
      margin-bottom: 8px;
    }
    
    .recommendation-text {
      font-size: 14px;
      color: #2c5282;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .comparison-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #4a5568;
    }
    
    .legend-marker {
      width: 16px;
      height: 3px;
      border-radius: 2px;
    }
    
    .legend-bar {
      width: 16px;
      height: 12px;
      border-radius: 2px;
      opacity: 0.8;
    }
    
    .axis path, .axis line { 
      stroke: #cbd5e0; 
      stroke-width: 1; 
    }
    
    .axis text { 
      font-family: 'Source Sans Pro', sans-serif; 
      font-size: 12px; 
      fill: #4a5568; 
    }
    
    .hidden { display: none !important; }
    
      @media (max-width: 1200px) {
        .content-area {
          grid-template-columns: 1fr;
          padding: 24px 16px;
          gap: 24px;
        }
        
        .insights-sidebar {
          max-width: none;
          min-width: auto;
        }
      }
      
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 16px;
          text-align: center;
        }
        
        .main-container {
          padding: 0 16px;
        }
        
        .control-row {
          flex-direction: column;
          align-items: stretch;
        }
        
        .field-group {
          min-width: auto;
        }
        
        .comparison-controls {
          grid-template-columns: 1fr;
        }
      }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo">Swimmate</div>
        <div class="tagline">Port Phillip Bay Water Quality Analysis</div>
      </div>
      <div id="status" class="data-status">
        <div class="status-dot"></div>
        <span>Historical Data Analysis</span>
      </div>
    </div>
  </header>

  <div class="main-container">
    <div class="analysis-card">
      <div class="card-nav">
        <button class="nav-button active" onclick="switchMode('single')">Beach Analysis</button>
        <button class="nav-button" onclick="switchMode('comparison')">Compare Beaches</button>
      </div>
      
      <!-- Single Beach Mode -->
      <div id="single-mode">
        <div class="controls-panel">
          <div class="control-row">
            <div class="field-group">
              <label class="field-label">Beach Location</label>
              <select id="beach-select" class="field-input">
                <option value="">Select a beach...</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label">Analysis Period</label>
              <select id="year-select" class="field-input">
                <option value="">All available data</option>
              </select>
            </div>
            <button id="analyze-single" class="analyze-btn" onclick="analyzeBeach()">Analyze</button>
          </div>
        </div>
        
        <div class="content-area">
          <div class="chart-section">
            <div id="chart-title" class="chart-title hidden"></div>
            <div id="chart-container" class="chart-container">
              <div id="welcome-state" class="empty-state">
                <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                  <div style="font-size: 24px; font-weight: 600; color: #1a202c; margin-bottom: 16px;">üèä‚Äç‚ôÄÔ∏è Find Your Perfect Beach</div>
                  <p style="font-size: 16px; color: #4a5568; margin-bottom: 24px; line-height: 1.6;">
                    Discover the best swimming spots in Port Phillip Bay with real water quality data. 
                    Select a beach above to see detailed analysis, or compare multiple beaches to find the safest option.
                  </p>
                  <div id="loading-recommendations" style="display: none;">
                    <div style="font-size: 14px; color: #64748b;">Loading beach recommendations...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quality Breakdown and Recommendations -->
            <div id="quality-breakdown-section" class="hidden" style="margin-top: 32px;">
              <!-- Quality Metrics Summary -->
              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                  <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #1a202c;">Water Quality Summary</h3>
                  <div style="display: flex; gap: 32px;">
                    <div style="text-align: center;">
                      <div id="total-tests-main" style="font-size: 28px; font-weight: 700; color: #2b6cb0;">-</div>
                      <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Total Tests</div>
                    </div>
                    <div style="text-align: center;">
                      <div id="avg-rating-main" style="font-size: 28px; font-weight: 700; color: #2b6cb0;">-</div>
                      <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Avg Rating</div>
                    </div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 10px; border: 1px solid #bbf7d0; box-shadow: 0 1px 3px rgba(34, 197, 94, 0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 20px; height: 20px; border-radius: 6px; background: #22c55e; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);"></div>
                      <span style="font-weight: 600; color: #14532d; font-size: 15px;">Safe</span>
                    </div>
                    <div id="safe-count-main" style="font-size: 24px; font-weight: 800; color: #14532d;">0</div>
                  </div>
                  
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: 10px; border: 1px solid #fbbf24; box-shadow: 0 1px 3px rgba(245, 158, 11, 0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 20px; height: 20px; border-radius: 6px; background: #f59e0b; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);"></div>
                      <span style="font-weight: 600; color: #92400e; font-size: 15px;">Relatively Safe</span>
                    </div>
                    <div id="relatively-safe-count-main" style="font-size: 24px; font-weight: 800; color: #92400e;">0</div>
                  </div>
                  
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, #fff7ed, #fed7aa); border-radius: 10px; border: 1px solid #fb923c; box-shadow: 0 1px 3px rgba(251, 146, 60, 0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 20px; height: 20px; border-radius: 6px; background: #f97316; box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);"></div>
                      <span style="font-weight: 600; color: #9a3412; font-size: 15px;">Caution</span>
                    </div>
                    <div id="caution-count-main" style="font-size: 24px; font-weight: 800; color: #9a3412;">0</div>
                  </div>
                  
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, #fef2f2, #fecaca); border-radius: 10px; border: 1px solid #f87171; box-shadow: 0 1px 3px rgba(239, 68, 68, 0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 20px; height: 20px; border-radius: 6px; background: #ef4444; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);"></div>
                      <span style="font-weight: 600; color: #991b1b; font-size: 15px;">Unsafe</span>
                    </div>
                    <div id="unsafe-count-main" style="font-size: 24px; font-weight: 800; color: #991b1b;">0</div>
                  </div>
                </div>
              </div>
              
              <!-- Swimming Recommendation -->
              <div id="recommendations-main" style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #3b82f6; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                  <div style="width: 6px; height: 32px; background: #2563eb; border-radius: 3px;"></div>
                  <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e40af;">Swimming Recommendation</h3>
                </div>
                <div id="recommendation-text-main" style="font-size: 16px; line-height: 1.6; color: #1e40af; font-weight: 500;">
                  Select a beach and analyze to see swimming recommendations based on water quality data.
                </div>
              </div>
            </div>
          </div>
          
          <div class="insights-sidebar">
            <div id="beach-info" class="insight-box hidden">
              <div class="insight-title">Beach Information</div>
              <div id="beach-details"></div>
            </div>
            
            <!-- Top Beaches Widget -->
            <div id="top-beaches-widget" class="insight-box">
              <div class="insight-title" style="display: flex; align-items: center; gap: 8px;">
                <span>üèÜ</span>
                <span>Recommended Beaches</span>
              </div>
              <div id="top-beaches-content" style="font-size: 14px; color: #64748b;">
                Loading recommendations...
              </div>
            </div>
            
          </div>
        </div>
      </div>
      
      <!-- Comparison Mode -->
      <div id="comparison-mode" class="hidden">
        <div class="controls-panel">
          <div class="comparison-controls">
            <div class="field-group">
              <label class="field-label">Beach 1</label>
              <select id="beach1-select" class="field-input">
                <option value="">Select first beach...</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label">Beach 2</label>
              <select id="beach2-select" class="field-input">
                <option value="">Select second beach...</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label">Beach 3 (Optional)</label>
              <select id="beach3-select" class="field-input">
                <option value="">Select third beach...</option>
              </select>
            </div>
          </div>
          <button id="compare-btn" class="analyze-btn" onclick="compareBeaches()">Compare</button>
        </div>
        
        <div class="content-area">
          <div class="chart-section">
            <div id="comparison-title" class="chart-title hidden"></div>
            <div id="comparison-container" class="chart-container">
              <div class="empty-state">Select 2-3 beaches to compare water quality trends</div>
            </div>
            
            <!-- Comparison insights moved below the chart -->
            <div id="comparison-insights" class="insight-box hidden" style="margin-top: 32px;">
              <div class="insight-title">Comparison Results</div>
              <div id="comparison-details"></div>
            </div>
          </div>
          
          <div class="insights-sidebar">
            <!-- Empty sidebar for comparison mode - could add other widgets here later -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    let beaches = [];
    let currentMode = 'single';
    
    // Initialize
    async function init() {
      await checkConnection();
      await loadBeaches();
      populateYears();
      await loadTopBeachesRecommendations();
    }
    
    async function checkConnection() {
      try {
        const response = await fetch('/api/ping');
        const data = await response.json();
        // Connection status is always shown as "Historical Data Analysis"
        // since we're analyzing historical data, not live monitoring
      } catch (error) {
        document.getElementById('status').innerHTML = `
          <div class="status-dot" style="background: #f56565;"></div>
          <span>Connection Error</span>
        `;
      }
    }
    
    async function loadBeaches() {
      try {
        const response = await fetch('/api/beaches');
        beaches = await response.json();
        
        const selectors = ['beach-select', 'beach1-select', 'beach2-select', 'beach3-select'];
        selectors.forEach(selectorId => {
          const select = document.getElementById(selectorId);
          const isOptional = selectorId === 'beach3-select';
          select.innerHTML = isOptional ? '<option value="">Select third beach...</option>' : '<option value="">Select a beach...</option>';
          
          beaches.forEach(beach => {
            const option = document.createElement('option');
            option.value = beach.site_id;
            option.textContent = beach.site_name;
            select.appendChild(option);
          });
        });
      } catch (error) {
        console.error('Failed to load beaches:', error);
      }
    }
    
    function populateYears() {
      const yearSelect = document.getElementById('year-select');
      const currentYear = new Date().getFullYear();
      
      for (let year = currentYear; year >= 2013; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }
    
    async function loadTopBeachesRecommendations() {
      try {
        // Get a sample of popular beaches for quick recommendations
        const popularBeaches = [99020, 99060, 99070, 99290, 99160]; // Port Melbourne, Hampton, Half Moon Bay, Sorrento, Seaford
        const recommendations = [];
        
        for (const beachId of popularBeaches.slice(0, 3)) {
          try {
            const response = await fetch(`/api/beach-data?beachId=${beachId}&year=2024`);
            const data = await response.json();
            
            if (data.totalTests > 0) {
              const beach = beaches.find(b => b.site_id == beachId);
              const safePercent = ((data.qualityCounts.Safe || 0) / data.totalTests * 100);
              const avgRating = parseFloat(data.averageRating);
              
              recommendations.push({
                name: beach?.site_name || 'Unknown',
                safePercent: safePercent.toFixed(0),
                rating: avgRating.toFixed(1),
                id: beachId
              });
            }
          } catch (e) {
            console.log('Failed to load data for beach', beachId);
          }
        }
        
        // Sort by safe percentage
        recommendations.sort((a, b) => parseFloat(b.safePercent) - parseFloat(a.safePercent));
        
        let html = '';
        if (recommendations.length > 0) {
          html += '<div style="margin-bottom: 16px; font-size: 13px; color: #64748b;">Based on 2024 water quality data:</div>';
          recommendations.forEach((beach, index) => {
            const emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
            const ratingColor = parseFloat(beach.rating) >= 3.5 ? '#22c55e' : parseFloat(beach.rating) >= 3 ? '#3b82f6' : '#f59e0b';
            
            html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span style="font-size: 16px;">${emoji}</span>
                    <span style="font-weight: 600; color: #1a202c; font-size: 14px;">${beach.name}</span>
                  </div>
                  <div style="font-size: 12px; color: #64748b;">${beach.safePercent}% safe tests in 2024</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <div style="font-weight: 700; color: ${ratingColor}; font-size: 16px;">${beach.rating}/4</div>
                  <button onclick="selectBeach(${beach.id})" style="font-size: 12px; padding: 6px 12px; background: #2b6cb0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 60px;">Select</button>
                </div>
              </div>
            `;
          });
          
          // Only show tip when no beach is currently analyzed
          const isAnalyzing = !document.getElementById('beach-info').classList.contains('hidden');
          if (!isAnalyzing) {
            html += '<div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 13px; color: #1e40af; line-height: 1.4;">üí° <strong>Tip:</strong> Compare multiple beaches to find the best option for your visit</div>';
          }
        } else {
          html = '<div style="color: #64748b;">Unable to load recommendations at this time.</div>';
        }
        
        document.getElementById('top-beaches-content').innerHTML = html;
        
      } catch (error) {
        console.error('Failed to load beach recommendations:', error);
        document.getElementById('top-beaches-content').innerHTML = '<div style="color: #64748b;">Unable to load recommendations.</div>';
      }
    }
    
    function selectBeach(beachId) {
      document.getElementById('beach-select').value = beachId;
      document.getElementById('year-select').value = '2024';
      analyzeBeach();
    }
    
    function switchMode(mode) {
      currentMode = mode;
      
      // Update navigation
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="switchMode('${mode}')"]`).classList.add('active');
      
      // Show/hide content
      document.getElementById('single-mode').classList.toggle('hidden', mode !== 'single');
      document.getElementById('comparison-mode').classList.toggle('hidden', mode !== 'comparison');
      
      // Show/hide top beaches widget
      document.getElementById('top-beaches-widget').classList.toggle('hidden', mode !== 'single');
      
      // Apply comparison mode layout class
      document.body.classList.toggle('comparison-mode', mode === 'comparison');
      
      // Clear previous results
      clearResults();
    }
    
    function clearResults() {
      // Clear single mode
      document.getElementById('chart-container').innerHTML = '<div class="empty-state">Select a beach to begin water quality analysis</div>';
      document.getElementById('chart-title').classList.add('hidden');
      document.getElementById('quality-breakdown-section').classList.add('hidden');
      document.getElementById('beach-info').classList.add('hidden');
      
      // Clear comparison mode
      document.getElementById('comparison-container').innerHTML = '<div class="empty-state">Select 2-3 beaches to compare water quality trends</div>';
      document.getElementById('comparison-title').classList.add('hidden');
      document.getElementById('comparison-insights').classList.add('hidden');
      
      // Refresh recommendations to show tip again when no beach is analyzed
      loadTopBeachesRecommendations();
    }
    
    async function analyzeBeach() {
      const beachId = document.getElementById('beach-select').value;
      const year = document.getElementById('year-select').value;
      
      if (!beachId) {
        alert('Please select a beach to analyze');
        return;
      }
      
      const beach = beaches.find(b => b.site_id == beachId);
      showLoading('chart-container', 'Analyzing water quality data...');
      
      try {
        const url = `/api/beach-data?beachId=${beachId}${year ? `&year=${year}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.totalTests === 0) {
          document.getElementById('chart-container').innerHTML = '<div class="empty-state">No data available for selected period</div>';
          return;
        }
        
        renderBeachAnalysis(data, beach, year);
        updateBeachInsights(data, beach, year);
        
        // Refresh recommendations to hide tip when analyzing a beach
        loadTopBeachesRecommendations();
        
      } catch (error) {
        console.error('Analysis failed:', error);
        document.getElementById('chart-container').innerHTML = '<div class="empty-state">Analysis failed. Please try again.</div>';
      }
    }
    
    async function compareBeaches() {
      const beach1Id = document.getElementById('beach1-select').value;
      const beach2Id = document.getElementById('beach2-select').value;
      const beach3Id = document.getElementById('beach3-select').value;
      
      if (!beach1Id || !beach2Id) {
        alert('Please select at least 2 beaches to compare');
        return;
      }
      
      showLoading('comparison-container', 'Comparing beach data...');
      
      const beachIds = [beach1Id, beach2Id, beach3Id].filter(Boolean).join(',');
      
      try {
        const response = await fetch(`/api/beach-comparison?beachIds=${beachIds}`);
        const data = await response.json();
        
        renderBeachComparison(data);
        updateComparisonInsights(data);
        
      } catch (error) {
        console.error('Comparison failed:', error);
        document.getElementById('comparison-container').innerHTML = '<div class="empty-state">Comparison failed. Please try again.</div>';
      }
    }
    
    function showLoading(containerId, message) {
      document.getElementById(containerId).innerHTML = `<div class="empty-state">${message}</div>`;
    }
    
    function renderBeachAnalysis(data, beach, year) {
      const container = document.getElementById('chart-container');
      container.innerHTML = '';
      
      const title = document.getElementById('chart-title');
      title.textContent = `${beach.site_name} - Water Quality Analysis ${year ? `(${year})` : '(All Years)'}`;
      title.classList.remove('hidden');
      
      const width = 700;
      const height = 400;
      const margin = { top: 20, right: 120, bottom: 60, left: 70 };
      
      const svg = d3.select(container).append('svg')
        .attr('width', width)
        .attr('height', height);
      
      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      
      // Process data
      const monthlyData = data.monthlyData.map(d => ({
        ...d,
        date: new Date(d.month + '-01'),
        safeCount: Math.round(d.total * (+d.goodPercent) / 100),
        relativelySafeCount: Math.round(d.total * (+d.fairPercent) / 100),
        cautionCount: Math.round(d.total * (+d.poorPercent) / 100),
        unsafeCount: d.total - Math.round(d.total * (+d.goodPercent) / 100) - Math.round(d.total * (+d.fairPercent) / 100) - Math.round(d.total * (+d.poorPercent) / 100)
      })).sort((a, b) => a.date - b.date);
      
      if (monthlyData.length === 0) return;
      
      // Scales
      const xScale = d3.scaleBand()
        .domain(monthlyData.map(d => d3.timeFormat('%b %Y')(d.date)))
        .range([0, innerWidth])
        .padding(0.2);
      
      const yScale = d3.scaleLinear()
        .domain([0, Math.ceil(d3.max(monthlyData, d => d.total) * 1.1)])
        .range([innerHeight, 0]);
      
      const yScalePercent = d3.scaleLinear()
        .domain([0, 100])
        .range([innerHeight, 0]);
      
      // Enhanced color scheme for quality levels with gradients
      const colors = {
        safe: '#10b981',
        relativelySafe: '#f59e0b', 
        caution: '#f97316',
        unsafe: '#ef4444'
      };
      
      // Create stacked bar data
      const stackedData = monthlyData.map(d => ({
        month: d3.timeFormat('%b %Y')(d.date),
        date: d.date,
        safePercent: +d.goodPercent,
        values: [
          { key: 'safe', value: d.safeCount, color: colors.safe },
          { key: 'relativelySafe', value: d.relativelySafeCount, color: colors.relativelySafe },
          { key: 'caution', value: d.cautionCount, color: colors.caution },
          { key: 'unsafe', value: d.unsafeCount, color: colors.unsafe }
        ]
      }));
      
      // Left Axis (Test Count)
      g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(xScale))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-35)')
        .style('font-size', '11px');
      
      g.append('g')
        .call(d3.axisLeft(yScale)
          .tickFormat(d3.format('d'))
          .ticks(Math.min(6, Math.ceil(d3.max(monthlyData, d => d.total) * 1.1)))
        )
        .append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -50)
        .attr('x', -innerHeight / 2)
        .attr('dy', '1em')
        .style('text-anchor', 'middle')
        .style('fill', '#4a5568')
        .style('font-size', '12px')
        .text('Test Count');
      
      // (Right percentage axis will be drawn after bars/lines so it isn't covered)
      
      // Create grouped bars for each month
      const barGroups = g.selectAll('.bar-group')
        .data(stackedData)
        .enter().append('g')
        .attr('class', 'bar-group')
        .attr('transform', d => `translate(${xScale(d.month)},0)`);
      
      const barWidth = xScale.bandwidth() / 4;
      
      // Create gradient definitions for bars
      const defs = svg.append('defs');
      
      // Safe gradient
      const safeGradient = defs.append('linearGradient')
        .attr('id', 'safeGradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '0%').attr('y2', '100%');
      safeGradient.append('stop').attr('offset', '0%').attr('stop-color', '#34d399');
      safeGradient.append('stop').attr('offset', '100%').attr('stop-color', '#10b981');
      
      // Relatively Safe gradient
      const relativelySafeGradient = defs.append('linearGradient')
        .attr('id', 'relativelySafeGradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '0%').attr('y2', '100%');
      relativelySafeGradient.append('stop').attr('offset', '0%').attr('stop-color', '#fbbf24');
      relativelySafeGradient.append('stop').attr('offset', '100%').attr('stop-color', '#f59e0b');
      
      // Caution gradient
      const cautionGradient = defs.append('linearGradient')
        .attr('id', 'cautionGradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '0%').attr('y2', '100%');
      cautionGradient.append('stop').attr('offset', '0%').attr('stop-color', '#fb923c');
      cautionGradient.append('stop').attr('offset', '100%').attr('stop-color', '#f97316');
      
      // Unsafe gradient
      const unsafeGradient = defs.append('linearGradient')
        .attr('id', 'unsafeGradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '0%').attr('y2', '100%');
      unsafeGradient.append('stop').attr('offset', '0%').attr('stop-color', '#f87171');
      unsafeGradient.append('stop').attr('offset', '100%').attr('stop-color', '#ef4444');

      // Draw enhanced bars for each quality level
      barGroups.each(function(monthData) {
        const group = d3.select(this);
        
        monthData.values.forEach((qualityData, i) => {
          if (qualityData.value > 0) {
            const gradientMap = {
              'safe': 'url(#safeGradient)',
              'relativelySafe': 'url(#relativelySafeGradient)',
              'caution': 'url(#cautionGradient)',
              'unsafe': 'url(#unsafeGradient)'
            };
            
            group.append('rect')
              .attr('x', i * barWidth)
              .attr('width', barWidth - 1)
              .attr('y', yScale(qualityData.value))
              .attr('height', innerHeight - yScale(qualityData.value))
              .attr('fill', gradientMap[qualityData.key] || qualityData.color)
              .attr('stroke', 'white')
              .attr('stroke-width', 0.5)
              .attr('rx', 2)
              .attr('ry', 2)
              .style('filter', 'drop-shadow(0px 1px 2px rgba(0,0,0,0.1))')
              .append('title')
              .text(`${qualityData.key}: ${qualityData.value} tests`);
          }
        });
      });
      
      // Create gradient for the safe percentage line
      const lineGradient = defs.append('linearGradient')
        .attr('id', 'lineGradient')
        .attr('x1', '0%').attr('y1', '0%')
        .attr('x2', '100%').attr('y2', '0%');
      lineGradient.append('stop').attr('offset', '0%').attr('stop-color', '#10b981');
      lineGradient.append('stop').attr('offset', '50%').attr('stop-color', '#34d399');
      lineGradient.append('stop').attr('offset', '100%').attr('stop-color', '#10b981');

      // Enhanced safe percentage line (uses right axis scale)
      const safeLine = d3.line()
        .x(d => xScale(d.month) + xScale.bandwidth()/2)
        .y(d => yScalePercent(d.safePercent))
        .curve(d3.curveMonotoneX);
      
      g.append('path')
        .datum(stackedData)
        .attr('fill', 'none')
        .attr('stroke', 'url(#lineGradient)')
        .attr('stroke-width', 4)
        .style('filter', 'drop-shadow(0px 2px 4px rgba(16, 185, 129, 0.3))')
        .attr('d', safeLine);
      
      // Enhanced data points for safe percentage
      g.selectAll('.safe-point')
        .data(stackedData)
        .enter().append('circle')
        .attr('class', 'safe-point')
        .attr('cx', d => xScale(d.month) + xScale.bandwidth()/2)
        .attr('cy', d => yScalePercent(d.safePercent))
        .attr('r', 6)
        .attr('fill', '#10b981')
        .attr('stroke', 'white')
        .attr('stroke-width', 3)
        .style('filter', 'drop-shadow(0px 2px 4px rgba(16, 185, 129, 0.4))')
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 8)
            .attr('stroke-width', 4);
        })
        .on('mouseout', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 6)
            .attr('stroke-width', 3);
        })
        .append('title')
        .text(d => `${d.month}: ${d.safePercent}% safe`);

      // Enhanced percentage labels next to the dots
      g.selectAll('.safe-label')
        .data(stackedData)
        .enter().append('text')
        .attr('class', 'safe-label')
        .attr('x', d => xScale(d.month) + xScale.bandwidth()/2 + 15)
        .attr('y', d => yScalePercent(d.safePercent))
        .attr('dy', '0.35em')
        .style('text-anchor', 'start')
        .style('fill', '#065f46')
        .style('font-size', '13px')
        .style('font-weight', '700')
        .style('font-family', 'Source Sans Pro, sans-serif')
        .style('text-shadow', '0px 1px 2px rgba(255,255,255,0.8)')
        .text(d => `${d.safePercent}%`);

      // RIGHT AXIS FOR PERCENTAGE (0-100%) - DRAW LAST TO ENSURE VISIBILITY
      const rightAxis = g.append('g')
        .attr('class', 'right-axis-percentage')
        .attr('transform', `translate(${innerWidth},0)`)
        .call(d3.axisRight(yScalePercent)
          .tickFormat(d => d + '%')
          .tickValues([0, 20, 40, 60, 80, 100])
          .tickSize(12)
        );

      rightAxis.raise();

      // Enhanced right axis styling
      rightAxis.selectAll('text')
        .style('fill', '#065f46')
        .style('font-weight', 'bold')
        .style('font-size', '14px')
        .style('font-family', 'Source Sans Pro, sans-serif')
        .style('text-shadow', '0px 1px 2px rgba(255,255,255,0.8)');

      rightAxis.selectAll('line')
        .style('stroke', '#10b981')
        .style('stroke-width', '2')
        .style('opacity', '0.8');

      rightAxis.select('.domain')
        .style('stroke', '#10b981')
        .style('stroke-width', '3')
        .style('opacity', '0.9');

      rightAxis.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', 65)
        .attr('x', -innerHeight / 2)
        .attr('dy', '1em')
        .style('text-anchor', 'middle')
        .style('fill', '#065f46')
        .style('font-size', '14px')
        .style('font-weight', 'bold')
        .style('text-shadow', '0px 1px 2px rgba(255,255,255,0.8)')
        .text('Safe Percentage (0-100%)');
      
      // Legend
      const legend = d3.select(container).append('div').attr('class', 'legend');
      
      const legendItems = [
        { color: colors.safe, label: 'Safe', type: 'bar' },
        { color: colors.relativelySafe, label: 'Relatively Safe', type: 'bar' },
        { color: colors.caution, label: 'Caution', type: 'bar' },
        { color: colors.unsafe, label: 'Unsafe', type: 'bar' },
        { color: '#22c55e', label: 'Safe %', type: 'line' }
      ];
      
      legendItems.forEach(item => {
        const legendItem = legend.append('div').attr('class', 'legend-item');
        legendItem.append('div')
          .attr('class', item.type === 'bar' ? 'legend-bar' : 'legend-marker')
          .style('background-color', item.color);
        legendItem.append('span').text(item.label);
      });
    }
    
    function renderBeachComparison(data) {
      const container = document.getElementById('comparison-container');
      container.innerHTML = '';
      
      const title = document.getElementById('comparison-title');
      title.textContent = 'Beach Water Quality Comparison';
      title.classList.remove('hidden');
      
      const width = 700;
      const height = 400;
      const margin = { top: 20, right: 100, bottom: 60, left: 70 };
      
      const svg = d3.select(container).append('svg')
        .attr('width', width)
        .attr('height', height);
      
      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      
      // Get all years
      const allYears = [...new Set(data.flatMap(beach => beach.yearlyData.map(d => d.year)))].sort();
      
      // Scales
      const xScale = d3.scaleLinear()
        .domain(d3.extent(allYears))
        .range([0, innerWidth]);
      
      const yScale = d3.scaleLinear()
        .domain([0, 100])
        .range([innerHeight, 0]);
      
      // Axes
      g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(xScale).tickFormat(d3.format('d')));
      
      g.append('g')
        .call(d3.axisLeft(yScale))
        .append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', -50)
        .attr('x', -innerHeight / 2)
        .attr('dy', '1em')
        .style('text-anchor', 'middle')
        .style('fill', '#4a5568')
        .style('font-size', '12px')
        .text('Safe Water Quality (%)');
      
      // Colors
      const colors = ['#2b6cb0', '#48bb78', '#ed8936'];
      
      // Draw lines
      data.forEach((beach, i) => {
        const line = d3.line()
          .x(d => xScale(d.year))
          .y(d => yScale(+d.goodPercent))
          .curve(d3.curveMonotoneX);
        
        g.append('path')
          .datum(beach.yearlyData)
          .attr('fill', 'none')
          .attr('stroke', colors[i])
          .attr('stroke-width', 3)
          .attr('d', line);
        
        // Points
        g.selectAll(`.point-${i}`)
          .data(beach.yearlyData)
          .enter().append('circle')
          .attr('class', `point-${i}`)
          .attr('cx', d => xScale(d.year))
          .attr('cy', d => yScale(+d.goodPercent))
          .attr('r', 4)
          .attr('fill', colors[i]);
      });
      
      // Legend
      const legend = d3.select(container).append('div').attr('class', 'legend');
      
      data.forEach((beach, i) => {
        const legendItem = legend.append('div').attr('class', 'legend-item');
        legendItem.append('div')
          .attr('class', 'legend-marker')
          .style('background-color', colors[i]);
        legendItem.append('span').text(beach.beachName);
      });
    }
    
    function updateBeachInsights(data, beach, year) {
      // Beach info
      const beachInfo = document.getElementById('beach-info');
      document.getElementById('beach-details').innerHTML = `
        <div style="font-weight: 600; font-size: 18px; margin-bottom: 6px; color: #1a202c;">${beach.site_name}</div>
        <div style="color: #64748b; font-size: 14px; margin-bottom: 8px;">üìç Port Phillip Bay, Melbourne</div>
        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 12px; margin-top: 12px;">
          <div style="font-size: 12px; color: #0c4a6e; font-weight: 600; margin-bottom: 4px;">ANALYSIS PERIOD</div>
          <div style="font-size: 14px; color: #0c4a6e; font-weight: 500;">${year || 'All available data'}</div>
        </div>
      `;
      beachInfo.classList.remove('hidden');
      
      // Update main metrics section
      document.getElementById('total-tests-main').textContent = data.totalTests;
      document.getElementById('avg-rating-main').textContent = `${data.averageRating}/4`;
      
      // Update main quality breakdown section
      document.getElementById('safe-count-main').textContent = data.qualityCounts.Safe || 0;
      document.getElementById('relatively-safe-count-main').textContent = data.qualityCounts['Relatively Safe'] || 0;
      document.getElementById('caution-count-main').textContent = data.qualityCounts.Caution || 0;
      document.getElementById('unsafe-count-main').textContent = data.qualityCounts.Unsafe || 0;
      
      // Show the quality breakdown section
      document.getElementById('quality-breakdown-section').classList.remove('hidden');
      
      // Recommendations - Enhanced Logic
      const avgRating = parseFloat(data.averageRating);
      const safePercent = ((data.qualityCounts.Safe || 0) / data.totalTests * 100);
      const relativelySafePercent = ((data.qualityCounts['Relatively Safe'] || 0) / data.totalTests * 100);
      const cautionPercent = ((data.qualityCounts.Caution || 0) / data.totalTests * 100);
      const unsafePercent = ((data.qualityCounts.Unsafe || 0) / data.totalTests * 100);
      const combinedSafePercent = safePercent + relativelySafePercent;
      
      // Get recent trend from monthly data (last 3 months vs first 3 months if available)
      let trendIndicator = '';
      if (data.monthlyData && data.monthlyData.length >= 6) {
        const recentMonths = data.monthlyData.slice(-3);
        const earlyMonths = data.monthlyData.slice(0, 3);
        const recentAvg = recentMonths.reduce((sum, m) => sum + parseFloat(m.goodPercent), 0) / 3;
        const earlyAvg = earlyMonths.reduce((sum, m) => sum + parseFloat(m.goodPercent), 0) / 3;
        
        if (recentAvg > earlyAvg + 5) trendIndicator = ' Recent improvements noted.';
        else if (recentAvg < earlyAvg - 5) trendIndicator = ' Recent decline in quality observed.';
      }
      
      let recommendation = '';
      let icon = '';
      let status = '';
      
      // More nuanced recommendation logic based on multiple factors
      if (combinedSafePercent >= 85 && unsafePercent <= 5) {
        icon = 'üèä‚Äç‚ôÄÔ∏è';
        status = 'Excellent choice for swimming!';
        recommendation = `This beach consistently maintains high water quality standards with ${safePercent.toFixed(1)}% safe and ${relativelySafePercent.toFixed(1)}% relatively safe tests.${trendIndicator}`;
      } else if (combinedSafePercent >= 70 && unsafePercent <= 10) {
        icon = '‚úÖ';
        status = 'Good choice for swimming.';
        recommendation = `Generally reliable water quality with ${combinedSafePercent.toFixed(1)}% of tests rating safe or relatively safe. Monitor conditions during peak season.${trendIndicator}`;
      } else if (combinedSafePercent >= 50 && unsafePercent <= 20) {
        icon = '‚ö†Ô∏è';
        status = 'Swim with caution.';
        recommendation = `Variable water quality - ${cautionPercent.toFixed(1)}% of tests show caution levels. Check recent conditions and consider swimming after dry weather.${trendIndicator}`;
      } else if (unsafePercent >= 20) {
        icon = 'üö´';
        status = 'High risk - consider alternatives.';
        recommendation = `${unsafePercent.toFixed(1)}% of tests rated as unsafe. This beach shows frequent water quality issues. Consider nearby alternatives for safer swimming.${trendIndicator}`;
      } else {
        icon = 'ü§î';
        status = 'Mixed conditions - check recent reports.';
        recommendation = `Water quality varies significantly at this location. Check current conditions and recent weather before swimming.${trendIndicator}`;
      }
      
      document.getElementById('recommendation-text-main').innerHTML = `${icon} <strong>${status}</strong> ${recommendation}`;
    }
    
    function updateComparisonInsights(data) {
      const avgRatings = data.map(beach => {
        const ratings = beach.yearlyData.map(year => parseFloat(year.rating));
        const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
        const latestYear = Math.max(...beach.yearlyData.map(d => d.year));
        const latestData = beach.yearlyData.find(d => d.year === latestYear);
        
        return { 
          name: beach.beachName, 
          rating: avgRating,
          latestSafe: parseFloat(latestData?.goodPercent || 0),
          trend: beach.yearlyData.length > 1 ? 
            (parseFloat(beach.yearlyData[beach.yearlyData.length - 1].rating) - parseFloat(beach.yearlyData[0].rating)) : 0
        };
      }).sort((a, b) => b.rating - a.rating);
      
      let comparisonHtml = '<div style="margin-bottom: 20px;">';
      comparisonHtml += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">`;
      comparisonHtml += `<span style="font-size: 20px;">üèÜ</span>`;
      comparisonHtml += `<div style="font-weight: 600; color: #2b6cb0; font-size: 16px;">Best Choice: ${avgRatings[0].name}</div>`;
      comparisonHtml += `</div>`;
      
      comparisonHtml += '<div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;">';
      comparisonHtml += `<div style="font-size: 14px; color: #0c4a6e; margin-bottom: 8px;"><strong>Why this beach wins:</strong></div>`;
      comparisonHtml += `<div style="font-size: 13px; color: #0c4a6e; line-height: 1.4;">`;
      comparisonHtml += `‚Ä¢ Highest average rating: <strong>${avgRatings[0].rating.toFixed(1)}/4.0</strong><br>`;
      comparisonHtml += `‚Ä¢ Recent safe tests: <strong>${avgRatings[0].latestSafe.toFixed(0)}%</strong><br>`;
      comparisonHtml += `‚Ä¢ Quality trend: ${avgRatings[0].trend > 0 ? 'üìà Improving' : avgRatings[0].trend < -0.1 ? 'üìâ Declining' : '‚û°Ô∏è Stable'}`;
      comparisonHtml += `</div></div>`;
      
      // Ranking table
      comparisonHtml += '<div style="margin-bottom: 16px;">';
      comparisonHtml += '<div style="font-weight: 600; color: #1a202c; margin-bottom: 8px;">Complete Ranking:</div>';
      avgRatings.forEach((beach, index) => {
        const emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
        const ratingColor = beach.rating >= 3.5 ? '#22c55e' : beach.rating >= 3 ? '#3b82f6' : '#f59e0b';
        const trendIcon = beach.trend > 0.1 ? 'üìà' : beach.trend < -0.1 ? 'üìâ' : '‚û°Ô∏è';
        
        comparisonHtml += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: ${index === 0 ? '#f0f9ff' : '#f8fafc'}; border-radius: 6px; margin-bottom: 4px; border: 1px solid ${index === 0 ? '#0ea5e9' : '#e2e8f0'};">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span>${emoji}</span>
              <span style="font-weight: 500; color: #1a202c; font-size: 14px;">${beach.name}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="text-align: right;">
                <div style="font-weight: 600; color: ${ratingColor}; font-size: 13px;">${beach.rating.toFixed(1)}/4</div>
                <div style="font-size: 11px; color: #64748b;">${beach.latestSafe.toFixed(0)}% safe</div>
              </div>
              <span style="font-size: 12px;" title="Quality trend">${trendIcon}</span>
            </div>
          </div>
        `;
      });
      comparisonHtml += '</div>';
      
      comparisonHtml += '<div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px;">';
      comparisonHtml += '<div style="font-size: 12px; color: #92400e; line-height: 1.4;">';
      comparisonHtml += '<strong>üí° Quick Decision Guide:</strong><br>';
      comparisonHtml += `‚Ä¢ <strong>Best Overall:</strong> ${avgRatings[0].name}<br>`;
      comparisonHtml += `‚Ä¢ <strong>Most Consistent:</strong> ${avgRatings.find(b => Math.abs(b.trend) < 0.1)?.name || avgRatings[0].name}<br>`;
      comparisonHtml += `‚Ä¢ Always check recent conditions before swimming`;
      comparisonHtml += '</div></div>';
      
      document.getElementById('comparison-details').innerHTML = comparisonHtml;
      document.getElementById('comparison-insights').classList.remove('hidden');
    }
    
    // Initialize the application
    init();
  </script>
</body>
</html>
